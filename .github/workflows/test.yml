name: CI workflow

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

  # Optional: keep pull_request, but note secrets won't be available for PRs from forks
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install "dvc[gdrive]"

      - name: Write GDrive credentials JSON
        env:
          GDRIVE_CREDENTIALS_DATA: ${{ secrets.GDRIVE_CREDENTIALS_DATA }}
        run: |
          python - <<'PY'
          import os, json
          s = os.environ.get("GDRIVE_CREDENTIALS_DATA", "")
          assert s.strip(), "Secret GDRIVE_CREDENTIALS_DATA is EMPTY (check workflow trigger / secret name)."
          with open("gdrive-sa.json", "w", encoding="utf-8") as f:
              f.write(s)
          # Validate JSON without printing it
          with open("gdrive-sa.json", "r", encoding="utf-8") as f:
              json.load(f)
          print("GDrive creds written. bytes =", len(s))
          PY

      - name: Configure DVC remote auth (local)
        run: |
          dvc remote modify --local gdrive_remote gdrive_use_service_account true
          dvc remote modify --local gdrive_remote gdrive_service_account_json_file_path gdrive-sa.json
          dvc remote modify --local gdrive_remote gdrive_acknowledge_abuse true

      - name: DVC Pull Data
        run: dvc pull -v

      - name: Run model tests
        run: |
          python main.py --mode test \
            --data_path data/test \
            --model_path models/cnn_resnet18_freeze_backbone_False.pth
